<!DOCTYPE html> 
<html>
<head>
<meta charset=utf-8>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="application-name" content="TVHadmin">
<title>TVHadmin - Timeline</title>
<script src="include.js"></script>
<script>
  window.addEventListener('load',function() {
    var mytop=document.getElementById("mobmenu");
    mytop.addEventListener('click', function() {
        var mynav=document.getElementById("navigation");
        if (mynav.classList.contains('focus'))
            mynav.classList.remove('focus');
        else mynav.classList.add('focus');
    });
  },false);

    window.onresize = function() {
      if(globalResizeTimer != null) window.clearTimeout(globalResizeTimer);
      globalResizeTimer = window.setTimeout(drawCursor, 200, refresh);
    };

  function click_tag(prefix, tagID) {
    var chk;
    if (document.getElementById(tagID).checked) chk = 1;
    else chk = -1;
    sessionStorage.setItem((prefix+tagID), chk);
    location.reload();
  }

  function make_timer(event_id, title) {
    if (confirm(`Create Timer for "${title}"?`)) {
      const profile_uuid = cookies.UUID;
      fetch(`/api/dvr/entry/create_by_event?event_id=${event_id}&config_uuid=${profile_uuid}`).then(function(response) {
        if (response.ok) {
	  update(0);
        }
      });
    }
  }

  function drawCursor(refresh) {
    var time = Date.now()/1000;
    if(time > tnext) {
      update(0);
    }
    var cursor = document.getElementById('timenow');
    if((time >= tstart) && (time < tend)) {
      var elem = document.getElementById('timeline');
      var start = elem.offsetTop;
      cursor.style.top = (start+33) + 'px';
      cursor.style.height = (elem.offsetHeight-start) + 'px';
      var delta = (time%1800)/textent;
      var pos = elem.offsetLeft + 6 + ch_width
	+ 0.98*delta*(elem.offsetWidth-ch_width-6);
      cursor.style.left = pos + 'px';
      cursor.style.visibility = 'visible';
    }
    if(refresh == 1) {
      var sync = (time % 60) * 1000;
      setTimeout(drawCursor, 63000-sync, 1);  // Avoid race
    }
  }

  async function update(first) {
    var now = Math.floor(Date.now() / 1000);
    var utime = now;
    if (params.has('start')) {
      utime = Math.max(now, params.get('start'));
    }
    tstart = utime - utime % 1800;
    tend = tstart + textent;
    tnext = tend;
    var wday = strftime('%a %e %b', utime);
    if (now < tstart) {
      var tleft = utime - textent/2;
      var s = `<a href='timeline.html?start=${tleft}' ><img src='images/left.png' alt='Go Back' title='left'></a>&nbsp;`;
    }
    else var s = "<img src='images/spacer.gif' style='width:20px;height:32px;'>&nbsp;";
    var tright = utime + textent/2;
    s += `<a href='timeline.html?start=${tright}' ><img src='images/right.png' alt='Go Forward' title='right'></a>`;
    document.getElementById("arrows").innerHTML = s;
    s = `<th>${wday}</th><th>`;
    var t = tstart;
    for (i=0; i<4; i++) {
      let time = strftime('%H:%M', t);
      s += `<div class='row_alt' style='float: left; width: 24.5%;'>${time}</div>`;
      t += textent / 4;
    }
    s += '</th>';
    document.getElementById('newday').innerHTML = s;

    if (last_tend != tend) {
      events = await get_epg('', tstart, tend);
      last_tend = tend;
    }
    var i = 0;
    for (const c of channels) {
      if (!(media.All)) {
        if (intersect(c.tags, media) == 0) continue;
      }
      if (first) var row = table.insertRow(-1);
      else var row = table.children[i];
      if (lcn) var name = `${c.number} ${c.name}`;
      else var name = c.name;
      var e = events.filter(m => m.channelUuid === c.uuid);
      var wd = 98 - e.length/8;
      s = `<td class='col_channel row_${i%2}'><div class='channel_name'>${name}</div></td><td class='col_schedule'>`;
      if (e.length) {
        for (const p of e) {
          if (p.start >= tend) break;
          if (p.stop <= now) continue;
	  if (p.start <= now && p.stop > now) {
	    if (p.start > tstart) {	//Need a spacer
	      spc = ((p.start - tstart) * wd) / textent;
	      s += `<div class='spacer' style='width: ${spc}%;'> <img src='images/spacer.gif' width=1 height=1 alt=''></div>`;
	    }
	    // var colour = 'onNow';
            var colour = categorystyles[p.genre] || 'onNow';
	    tnext = Math.min(tnext, p.stop);
	    p.onNow = 1;
	  }
	  //else var colour = 'onSoon';
          else var colour = categorystyles[p.genre] || 'onSoon';
	  if (p.dvrState == 'scheduled' || p.dvrState == 'recording') {
	    colour = 'record';
	  }
	  var duration = Math.min(tend, p.stop) - Math.max(tstart, p.start);
	  if (duration == 0) continue;
	  var pc = (wd * duration) / textent;
	  if (p.summary) var desc = p.summary;
	  else if (p.description) var desc = p.description;
	  else var desc = "";
	  var subtitle = htmlspecialchars(desc);
	  if (p.onNow) s += `<a href='/play/stream/channel/${c.uuid}?title=${c.name}'><div class='item ${colour}' style='width: ${pc}%;' title='${subtitle}'>${p.title}</div></a>`;
	  else if (p.dvrState) s += `<div class='item  ${colour}' style='width: ${pc}%;' title='${subtitle}'>${p.title}</div>`;
	  else {
	    var esctitle = htmlspecialchars(p.title);
	    s += `<div class='item  ${colour}' style='width: ${pc}%; cursor: pointer;' title='${subtitle}' onclick='make_timer("${p.eventId}", "${esctitle}")'>${p.title}</div>`;
	  }
	}
	s += "</td>";
      }
      else {
        s += `<a href='/play/stream/channel/${c.uuid}?title=${c.name}'><div class='item onNow' style='width: 98%;'>No EPG Available</div></a></td>`;
      }
      row.innerHTML = s;
      i++;
    }
  }
</script>
</head> 
<body>
<div id="container">
  <div id="navigation">
    <div class="logo">
      <img src="images/logo.png" alt="TVHeadend Logo" width="150">
    </div>
    <div class="nav_bar">
    <div class="navi"><a href="now.html">What's On Now</a></div>
    <div class="navi"><a href="timeline.html">Timeline</a></div>
    <div class="navi"><a href="channels.html">Channels</a></div>
    <div class="navi"><a href="favourites.html">Favourite Channels</a></div>
    <div class="navi"><a href="timers.html">Timers</a></div>
    <div class="navi"><a href="recordings.html">Recordings</a></div>
    <div class="navi"><a href="links.html">Series Links</a></div>
    <div class="navi"><a href="status.html">Status</a></div>
    <div class="navi"><a href="config.html">Configuration</a></div>
      <form action="search.html" method="GET" name="search" class="search" onsubmit="return checkForm()">
        <input type="text" name="find"><br>
        <input type="submit" name="submit" value="Search">
      </form>
    </div>
  </div>
    <div id='layout'>
      <div id='banner'>
        <table>
          <tr>
	    <td class='col_title'><div id='mobmenu'>&#9776;</div> <h1>Timeline</h1></td>
	    <td id='mediatags'></td>
	    <td id='arrows'></td>
	  </tr>
        </table>
      </div>
      <div id='wrapper'>
        <div id='timeline'>
	  <table class='list' id='list' style='table-layout: fixed;'>
	    <colgroup>
	      <col id='channelname'>
	      <col id='schedules'>
	    </colgroup>
	    <thead>
	      <tr class='newday' id='newday'>
	      </tr>
	    </thead>
	    <tbody>
	    </tbody>
	  </table>
	  <span id='timenow' style='visibility: hidden'>
	    <img src='images/spacer.gif' width='1' height='1' alt=''>
	  </span>
	</div>
      </div>
   </div>
  </div>
<script>
  var textent, tstart, tend, tnext, ch_width, params, last_tend=0;
  var channels, tags, events, table, media, lcn;
  var globalResizeTimer = null;
  var cookies = get_cookies();

  async function main() {
    var tags = await get_channeltags();
    var s = "<span class='wideonly'>";
    media = [];
    for (var key in cookies) {
      if (key.startsWith("Tag_")) {
	var tag = decodeURIComponent(key.substring(4));
	s += "<div class='media'>" +
		`<label for='${tag}'>${tag}:</label>` +
		`<input type='checkbox' name='${tag}' id='${tag}' onchange='click_tag("Tim_", "${tag}")'`;
	if (sessionStorage.getItem("Tim_"+tag)) {
	  if (sessionStorage.getItem("Tim_"+tag) == 1) {
	    s += " checked";
	    media[tags[tag]] = 1;
	  }
	}
	else if (cookies[("Tim_"+key.substring(4))]) {
	  s += " checked";
	  media[tags[tag]] = 1;
	}
	s += "></div>";
      }
    }
    s += "</span>";
    document.getElementById("mediatags").innerHTML = s;

    const query = window.location.search;
    params = new URLSearchParams(query);
    textent = 14400;
    if (cookies.TIMESPAN) textent = cookies.TIMESPAN * 3600;

    if (cookies.CSORT == 1) {
      lcn = 1;
      ch_width = 145;
    }
    else {
      lcn = 0;
      ch_width = 120;
    }
    document.getElementById('channelname').style = `width: ${ch_width}px`;

    channels = await get_channels(lcn);
    tags = await get_channeltags();
    table = document.getElementById("list").getElementsByTagName('tbody')[0];
    update(1);

    if (cookies.REFR) var refresh = 1;
    else var refresh = 0;
    drawCursor(refresh);
  }

  main();
</script>
 </body>
</html>
